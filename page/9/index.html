<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title> - page 9 - Side Notes</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="">
  <link rel="alternate" type="application/rss+xml" title="Side Notes" href="">

  <link href='/stylesheets/all-3946f92fb0c0a9c01c341f255decb03c.css' media='all' rel='stylesheet' type='text/css'>

  <!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
    src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>

</head>

  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Side Notes</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
          
            
            <a class="page-link" href="/about/">About</a>
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        </div>
      </nav>
    
  </div>
</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <style>
  .pager { text-align: center; }
  .pager div.previous { float: left; }
  .pager div.next { float: right; }
</style>

<div class="home">

  

  <ul class="post-list">
    
      <li>
        
        <span class="post-meta">Mar 31, 2010</span>

        <h2>
          <a class="post-link" href="/2010/03/31/integrating-rabbitmq-with-ejabberd/">Integrating RabbitMQ with ejabberd</a>
        </h2>
        <div class="entry-content">
          <p>ejabberd is integrated with RabbitMQ by means of <a href="http://tonyg.github.io/rabbitmq-xmpp/">mod_rabbitmq</a> gateway. If you followed my ejabberd installation <a href="/2010/02/23/get-started-with-ejabberd/">instructions</a>, you should already have mod_rabbitmq installed.</p>

<h2 id="configure-mod_rabbitmq">Configure mod_rabbitmq</h2>

<p>Open <em>/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg</em> file, find <em>modules</em> section, and add mod_rabbitmq stanza to the list</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span><span class="n">modules</span><span class="p">,</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">[</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="p">...</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="p">&#x7b;</span><span class="n">mod_rabbitmq</span><span class="p">,</span>  <span class="p">[&#x7b;</span><span class="n">rabbitmq_node</span><span class="p">,</span> <span class="nv">RABBIT_NODE</span><span class="p">&#x7d;]&#x7d;,</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="p">...</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">]&#x7d;.</span></div></div></pre></div></figure>

<p>You need to replace <em>RABBIT_NODE</em> with the real value, which you can find from the RabbitMQ process information</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ps -ef | grep beam
rabbitmq  8525  8142  0 16:37 pts/0    ... -sname rabbit@ubuntu ...
</code></pre></div></div>

<p>You can see my RabbitMQ node name is <em>rabbit@ubuntu</em>.</p>

<h2 id="set-up-cookie">Set up cookie</h2>

<p>To make RabbitMQ and ejabberd work together, they have to run in the same Erlang cluster. That means they have to use the same cookie file. If you <a href="/2010/03/14/get-started-with-rabbitmq/">installed</a> RabbitMQ from binary distribution, it uses the user’s cookie <em>~/.erlang.cookie</em>. ejabberd, on the other hand, uses its own cookie. Let’s replace it with the user’s</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd /opt/ejabberd/ejabberd/var/lib/ejabberd
$ rm -f .erlang.cookie
$ ln -s ~/.erlang.cookie
</code></pre></div></div>

<p>Restart ejabberd server</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /opt/ejabberd/ejabberd/sbin/ejabberdctl restart
</code></pre></div></div>

<h2 id="add-rabbit-buddy-to-roster">Add rabbit buddy to roster</h2>

<p>The rabbit’s JID consists of two parts: exchange name and routing domain. The routing domain is a string <code class="highlighter-rouge">rabbitmq.EJABBERD_HOST</code> where <em>EJABBERD_HOST</em> is the host you registered in <em>ejabberd.cfg</em>. In my case the routing domain is <code class="highlighter-rouge">rabbitmq.jabber.ndpar.com</code>.</p>

<p>For the name you can use any exchange name available in the RabbitMQ server. I use <code class="highlighter-rouge">amq.fanout</code> exchange which exists in every RabbitMQ server. So I go to my IM client (Adium) and add this user to the buddies list <code class="highlighter-rouge">amq.fanout@rabbitmq.jabber.ndpar.com</code>.</p>

<h2 id="rabbits-greetings">Rabbit’s greetings</h2>

<p>To publish a message to RabbitMQ I use the same Groovy script as in the previous <a href="/2010/03/14/get-started-with-rabbitmq/">post</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./publisher.groovy
</code></pre></div></div>

<p><img class="center" src="/images/posts/mod_rabbitmq.png" /></p>

<h3 id="resources">Resources</h3>

<ul>
  <li>Tony Garnock-Jones’ <a href="http://www.erlang-factory.com/upload/presentations/229/ErlangFactorySFBay2010-TonyGarnock-Jones.pdf">presentation slides</a> about RabbitMQ and its extensions.</li>
</ul>


        </div>
        
      </li>
    
      <li>
        
        <span class="post-meta">Mar 14, 2010</span>

        <h2>
          <a class="post-link" href="/2010/03/14/get-started-with-rabbitmq/">Get started with RabbitMQ</a>
        </h2>
        <div class="entry-content">
          <p><a href="http://www.rabbitmq.com">RabbitMQ</a> is an open-source implementation of <a href="http://en.wikipedia.org/wiki/AMQP">AMQP</a>. If you don’t know what AMQP is, I encourage you to read about it on the official web site or the reference <a href="http://www.rabbitmq.com/how.html">page</a>. What <em>I</em> personally like in RabbitMQ/AMQP is</p>

<ul>
  <li>AMQP is a free alternative to expensive TIBCO Randezvous.</li>
  <li>Functionality-wise AMQP is a superset of JMS.</li>
  <li>RabbitMQ is written in Erlang, which means fault-tolerance and reliability.</li>
</ul>

<p>In this short blog entry I show how to install RabbitMQ on a *nix box, and verify that it’s working with a simple Groovy client.</p>


        </div>
        
        <footer>
          <a rel="full-article" href="/2010/03/14/get-started-with-rabbitmq/">Read on →</a>
        </footer>
        
      </li>
    
      <li>
        
        <span class="post-meta">Feb 23, 2010</span>

        <h2>
          <a class="post-link" href="/2010/02/23/get-started-with-ejabberd/">Get started with ejabberd</a>
        </h2>
        <div class="entry-content">
          <h2 id="installation">Installation</h2>

<p>Before installing ejabberd make sure you have Erlang environment set up. Run the following command and verify the output</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ erl -version
Erlang (ASYNC_THREADS,HIPE) (BEAM) emulator version 5.10.1
</code></pre></div></div>

<p>I used to install ejabberd with apt-get command, which is convenient but always several versions behind. That’s why I switched to building from sources. All scripts below are assumed to be run under <em>ejabberd</em> user.</p>

<p>First, create a directory where all ejabberd versions will be installed, if it does not exist yet</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mkdir /opt/ejabberd
$ sudo chown -R ejabberd /opt/ejabberd
</code></pre></div></div>

<p>Download the sources</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd
$ git clone git@github.com:processone/ejabberd.git
$ cd ejabberd
</code></pre></div></div>

<p>Select version you want to install by executing <code class="highlighter-rouge">git branch -a</code> and <code class="highlighter-rouge">git tag --list</code> commands. Let assume we want to install version 2.1.12 from branch 2.1.x</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git checkout 2.1.x
$ cd src
</code></pre></div></div>

<p>The next step is optional. If you are going to integrate ejabberd with RabbitMQ, you need to download the source of rabbitmq-xmpp module</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wget https://raw.github.com/ndpar/rabbitmq-xmpp/rabbitmq3/src/mod_rabbitmq.erl
$ wget https://raw.github.com/ndpar/rabbitmq-xmpp/rabbitmq3/src/rabbit.hrl
</code></pre></div></div>

<p>Now we are ready to install ejabberd. To see all available configuration options, run <code class="highlighter-rouge">./configure --help</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./configure --prefix=/opt/ejabberd/ejabberd-2.1.12 --enable-user=ejabberd
$ make
$ make install
$ cd /opt/ejabberd
$ ln -s ejabberd-2.1.12 ejabberd
</code></pre></div></div>

<h2 id="configuration">Configuration</h2>

<p>Ejabberd comes with reasonable default configuration. Only two lines need to be changed to make it work in your environment.</p>

<p>Open <em>/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg</em> file and find <em>SERVED HOSTNAMES</em> section. By default Ejabberd is configured for localhost only. Change it to your machine’s DNS name. Here is what I have in my config</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">%%%'   SERVED HOSTNAMES</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span><span class="n">hosts</span><span class="p">,</span> <span class="p">[</span><span class="s">"jabber.ndpar.com"</span><span class="p">]&#x7d;.</span></div></div></pre></div></figure>

<p>The second thing we need to do is to configure admin user. Here is mine, registered for the host I just defined</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">%%%'   ACCESS CONTROL LISTS</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span><span class="n">acl</span><span class="p">,</span> <span class="n">admin</span><span class="p">,</span> <span class="p">&#x7b;</span><span class="n">user</span><span class="p">,</span> <span class="s">"andrey"</span><span class="p">,</span> <span class="s">"jabber.ndpar.com"</span><span class="p">&#x7d;&#x7d;.</span></div></div></pre></div></figure>

<p>Save the config file and start the server</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /opt/ejabberd/ejabberd/sbin/ejabberdctl start
</code></pre></div></div>

<p>You can quickly check the log file to see if the server has been started successfully</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ less /opt/ejabberd/ejabberd/var/log/ejabberd/ejabberd.log
</code></pre></div></div>

<p>If it wasn’t, you might want to enable debug logs</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">%%%'   DEBUGGING</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span><span class="n">loglevel</span><span class="p">,</span> <span class="mi">5</span><span class="p">&#x7d;.</span></div></div></pre></div></figure>

<p>and restart the server to see more details</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /opt/ejabberd/ejabberd/sbin/ejabberdctl restart
</code></pre></div></div>

<h2 id="registering-users">Registering users</h2>

<p>The first (admin) user has to be registered in command line</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd /opt/ejabberd/ejabberd/sbin
$ ./ejabberdctl register andrey jabber.ndpar.com ******
</code></pre></div></div>

<p>This user is the same as admin you configured in the previous section. If you go to <a href="http://localhost:5280/admin">localhost:5280/admin</a> in the browser, you should be able to login with the same password you registered the user</p>

<p><img class="center" src="/images/posts/ejabberd-web.png" /></p>

<p>Now you are ready to add newly created account to your Jabber client. In Adium, for example, go to <em>File</em> -&gt; <em>Add Acount</em> -&gt; <em>Jabber</em> and provide server hostname/IP, JID and password.</p>

<p><img class="center" src="/images/posts/ejabberd-adium-1.png" /></p>

<p><img class="center" src="/images/posts/ejabberd-adium-2.png" /></p>

<p>To really enjoy IM you need more users on your server. The best part here is that you can create new users just from your Jabber client. Simply go to <em>File</em> -&gt; <em>your ejabberd account</em> -&gt; <em>Add User</em></p>

<p><img class="center" src="/images/posts/ejabberd-admin-client.png" /></p>

<p>For other available options please consult <a href="http://www.ejabberd.im">official documentation</a>.</p>


        </div>
        
      </li>
    
      <li>
        
        <span class="post-meta">Nov 12, 2009</span>

        <h2>
          <a class="post-link" href="/2009/11/12/state-machine-in-erlang/">State Machine in Erlang</a>
        </h2>
        <div class="entry-content">
          <p>There is some sort of confusion in the object-oriented community about functional languages. How is it possible to implement stateful application if the language has no concept of state? It turns out that it’s actually quite possible, although the solution is completely deferent from what we see in the OO realm. In Erlang, for example, state can be implemented by using <em>process message passing</em> and <em>tail recursion</em>. This approach is so elegant that after you’ve learned it, the OO way of doing this looks unnatural. The code below is the Erlang implementation of Uncle Bob’s <a href="http://www.objectmentor.com/resources/articles/umlfsm.pdf">FSM example</a>. Look at it. Isn’t that code clean and expressive? It looks almost like DSL but it’s actually regular Erlang syntax.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">turnstile</span><span class="p">).</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">coin</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">pass</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">register</span><span class="p">(</span><span class="n">turnstile</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[])).</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">% Initial state</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">locked</span><span class="p">().</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">% Events</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">coin</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">turnstile</span> <span class="o">!</span> <span class="n">coin</span><span class="p">.</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">pass</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">turnstile</span> <span class="o">!</span> <span class="n">pass</span><span class="p">.</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">% States and transitions</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">locked</span><span class="p">()</span> <span class="o">-&gt;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">receive</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">pass</span> <span class="o">-&gt;</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">alarm</span><span class="p">(),</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">locked</span><span class="p">();</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">coin</span> <span class="o">-&gt;</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">unlock</span><span class="p">(),</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">unlocked</span><span class="p">()</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span><span class="p">.</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">unlocked</span><span class="p">()</span> <span class="o">-&gt;</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">receive</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">pass</span> <span class="o">-&gt;</span>
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">lock</span><span class="p">(),</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">locked</span><span class="p">();</span>
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">coin</span> <span class="o">-&gt;</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">thankyou</span><span class="p">(),</span>
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nf">unlocked</span><span class="p">()</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span><span class="p">.</span>
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">% Actions</span>
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">alarm</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"You shall not pass!</span><span class="si">~n</span><span class="s">"</span><span class="p">).</span>
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">unlock</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"Unlocking...</span><span class="si">~n</span><span class="s">"</span><span class="p">).</span>
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">lock</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"Locking...</span><span class="si">~n</span><span class="s">"</span><span class="p">).</span>
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nf">thankyou</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"Thank you for donation</span><span class="si">~n</span><span class="s">"</span><span class="p">).</span></div></div></pre></div></figure>

<p>The idea behind this code is simple. Every state is implemented as a function that does two things: it listens for messages sent by other processes; when message is received the appropriate action is taken and one of the <em>state-functions called recursively</em>. Simple.</p>


        </div>
        
      </li>
    
      <li>
        
        <span class="post-meta">Oct 22, 2009</span>

        <h2>
          <a class="post-link" href="/2009/10/22/parsing-files-using-groovy-regex/">Parsing files using Groovy regex</a>
        </h2>
        <div class="entry-content">
          <p>In my previous <a href="/2009/09/25/groovy-regular-expressions/">post</a> I mentioned several ways of defining regular expressions in Groovy. Here I want to show how we can use Groovy regex to find the data in the files.</p>

<h2 id="parsing-properties-file-simplified1">Parsing properties file (simplified)<sup>1</sup></h2>

<p><em>Data:</em> each line in the file has the same structure; the entire line can be matched by single regex.</p>

<p><em>Task:</em> transform each line to the object.</p>

<p><em>Solution:</em> construct regex with capturing parentheses, apply it to each line, extract captured data.</p>

<p><em>Demonstrates:</em> <code class="highlighter-rouge">File.eachLine</code> method, matrix syntax of <em>Matcher</em> object.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kt">def</span> <span class="n">properties</span> <span class="o">=</span> <span class="o">[:]</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s1">'path/to/some.properties'</span><span class="o">).</span><span class="na">eachLine</span> <span class="o">&#x7b;</span> <span class="n">line</span> <span class="o">-&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="o">((</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">line</span> <span class="o">=~</span> <span class="s">/^([^#=].*?)=(.+)$/</span><span class="o">))</span> <span class="o">&#x7b;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">properties</span><span class="o">[</span><span class="n">matcher</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">1</span><span class="o">]]</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">&#x7d;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">println</span> <span class="n">properties</span></div></div></pre></div></figure>

<h2 id="parsing-csv-files-simplified2">Parsing CSV files (simplified)<sup>2</sup></h2>

<p><em>Data:</em> each line in the file has the same structure; the line consists of the blocks separated by some character sequence.</p>

<p><em>Task:</em> transform each line to the list of objects.</p>

<p><em>Solution:</em> construct regex with capturing parentheses, parse each line with the regex in a loop extracting captured data.</p>

<p><em>Demonstrates:</em> <code class="highlighter-rouge">~//</code> <em>Pattern</em> defenition, <code class="highlighter-rouge">Matcher.group</code> method, <code class="highlighter-rouge">\G</code> regex meta-sequence.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kt">def</span> <span class="n">regex</span> <span class="o">=</span> <span class="o">~</span><span class="s">/\G(?:^|,)(?:"([^"]*+)"|([^",]*+))/</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s1">'path/to/file.csv'</span><span class="o">).</span><span class="na">eachLine</span> <span class="o">&#x7b;</span> <span class="n">line</span> <span class="o">-&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="o">[]</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kt">def</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">line</span><span class="o">)</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">while</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">&#x7b;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">fields</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">?:</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">println</span> <span class="n">fields</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">&#x7d;</span></div></div></pre></div></figure>

<h2 id="finding-snapshot-dependencies-in-the-pom-simplified3">Finding snapshot dependencies in the POM (simplified)<sup>3</sup></h2>

<p><em>Data:</em> file contains blocks with known boundaries (possibly spanning multiple lines).</p>

<p><em>Task:</em> extract the blocks satisfying some criteria.</p>

<p><em>Solution:</em> read the entire file into the string, construct regex with capturing parentheses, apply the regex to the string in a loop.</p>

<p><em>Demonstrates:</em> <code class="highlighter-rouge">File.text</code> property, list syntaxt of <em>Matcher</em> object, named capture, global <code class="highlighter-rouge">\x</code> regex modifier, local <code class="highlighter-rouge">\s</code> regex modifier.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">def pom = new File('path/to/pom.xml').text
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">def matcher = pom =~ $/(?x)
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    &lt;dependency&gt;                          \s*
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">      &lt;groupId&gt;([^&lt;]+)&lt;/groupId&gt;          \s*
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">      &lt;artifactId&gt;([^&lt;]+)&lt;/artifactId&gt;    \s*
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">      &lt;version&gt;(.+?-SNAPSHOT)&lt;/version&gt;   (?s:.*?)
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    &lt;/dependency&gt;
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">/$
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">matcher.each &#x7b; matched, groupId, artifactId, version -&gt;
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    println "$groupId:$artifactId:$version"
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">&#x7d;</div></div></pre></div></figure>

<h2 id="finding-stacktraces-in-the-log">Finding stacktraces in the log</h2>

<p><em>Data:</em> file contains entries each of which starts with the same pattern and can span multiple lines. Typical example is log4j log files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2009-10-16 15:32:12,157 DEBUG [com.ndpar.web.RequestProcessor] Loading user
2009-10-16 15:32:13,258 ERROR [com.ndpar.web.UserController] id to load is required for loading
java.lang.IllegalArgumentException: id to load is required for loading
     at org.hibernate.event.LoadEvent.(LoadEvent.java:74)
     at org.hibernate.event.LoadEvent.(LoadEvent.java:56)
     at org.hibernate.impl.SessionImpl.get(SessionImpl.java:839)
     at org.hibernate.impl.SessionImpl.get(SessionImpl.java:835)
     at org.springframework.orm.hibernate3.HibernateTemplate$1.doInHibernate(HibernateTemplate.java:531)
     at org.springframework.orm.hibernate3.HibernateTemplate.doExecute(HibernateTemplate.java:419)
     at org.springframework.orm.hibernate3.HibernateTemplate.executeWithNativeSession(HibernateTemplate.java:374)
     at org.springframework.orm.hibernate3.HibernateTemplate.get(HibernateTemplate.java:525)
     at org.springframework.orm.hibernate3.HibernateTemplate.get(HibernateTemplate.java:519)
     at com.ndpar.dao.UserManager.getUser(UserManager.java:90)
     ... 62 more
2009-10-16 15:32:14,659 DEBUG [com.ndpar.jms.MessageListener] Received message:
     ... multi-line message ...
2009-10-16 15:32:15,169 INFO  [com.ndpar.dao.UserManager] User: ...
</code></pre></div></div>

<p><em>Task:</em> find entries satisfying some criteria.</p>

<p><em>Solution:</em> read the entire file into the string<sup>4</sup>, construct regex with capturing parentheses and lookahead, split the string into entries, loop through the result and apply criteria to each entry.</p>

<p><em>Demonstrates:</em> regex interpolation, combined global regex modifiers <code class="highlighter-rouge">\s</code> and <code class="highlighter-rouge">\m</code>.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">def log = new File('path/to/your.log').text
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">def logLineStart = /^\d&#x7b;4&#x7d;-\d&#x7b;2&#x7d;-\d&#x7b;2&#x7d;/
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">def splitter = log =~ $/(?xms)
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    (    $&#x7b;logLineStart&#x7d;   .*?)
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    (?=  $&#x7b;logLineStart&#x7d; | \Z)
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">/$
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">splitter.each &#x7b; matched, entry -&gt;
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    if (entry =~ /(?m)^(?:\t| &#x7b;8&#x7d;)at/) println entry
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">&#x7d;</div></div></pre></div></figure>

<h3 id="resources">Resources</h3>

<ul>
  <li>Groovy <a href="http://groovy.codehaus.org/Regular+Expressions">regexes</a></li>
  <li>Groovy <a href="http://groovy.codehaus.org/Groovy+CLI">one-liners</a></li>
  <li>Using <a href="http://mrhaki.blogspot.com/2009/10/groovy-goodness-using-replaceall.html">String.replaceAll</a> method</li>
</ul>

<h3 id="footnotes">Footnotes</h3>

<ol>
  <li>This example is for demonstration purposes only. In real program you would just use <code class="highlighter-rouge">Properties.load</code> method.</li>
  <li>The regex is simplified. If you want the real one, take a look at Jeffrey Friedl’s <a href="http://regex.info/listing.cgi?ed=3&amp;p=401">example</a>.</li>
  <li>Again, in reality you would find snapshots using <code class="highlighter-rouge">mvn dependency:resolve | grep SNAPSHOT</code> command.</li>
  <li>This approach won’t work for big files. Take a look at this <a href="http://github.com/ndpar/utilities/blob/master/stacktraces.groovy">script</a> for practical solution.</li>
</ol>


        </div>
        
      </li>
    
  </ul>

  
  <div class="pager">
      
      <div class="previous">
          <a href="/page/10/index.html">&larr; Older Posts</a>
      </div>
      
      <span class="archive">
          <a href="/archive/">Archive</a>
      </span>
      
      <div class="next">
          <a href="/page/8/index.html">Newer Posts &rarr;</a>
      </div>
      
  </div>
  
  
</div>


      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-credit">

      <span class="footer-credit-left">
        Copyright &copy; 2009–2018 Andrey Paramonov
      </span>

      <span class="footer-credit-right">
        Powered by <a href="https://github.com/octopress/octopress">Octopress</a> •
        Hosted by <a href="https://github.com">GitHub</a>
      </span>

    </div>

  </div>

</footer>

  </body>

</html>
