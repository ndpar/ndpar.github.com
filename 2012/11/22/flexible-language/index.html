<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Flexible language - Side Notes</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="">
  <link rel="alternate" type="application/rss+xml" title="Side Notes" href="">

  <link href='/stylesheets/all-3946f92fb0c0a9c01c341f255decb03c.css' media='all' rel='stylesheet' type='text/css'>

  <!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
    src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>

</head>

  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Side Notes</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
          
            
            <a class="page-link" href="/about/">About</a>
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        </div>
      </nav>
    
  </div>
</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Flexible language</h1>
    <p class="post-meta">
      <time datetime="2012-11-22T07:00:00-05:00" itemprop="datePublished">
        
        Nov 22, 2012
      </time>
      
      
        • <span>Categories: Clojure</span>
      
      
        • <span>Tags: clojure, java, lisp</span>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I’ve been learning Lisp for few years now, and every Lisp book I read keeps saying that Lisp is a flexible language that you can extend to the degree when it fits naturally to your domain. It’s easy to say, but what exactly does this phrase mean? After all, when you program in your non-Lisp language, don’t you modify it for your domain problem? I’ve been thinking about it for a long time, and only recently I started to understand what flexibility really means. There is a difference between <em>using</em> the language and <em>changing</em> the language to solve a problem. In this post I will try to show the difference based on a simple example.</p>

<h2 id="problem">Problem</h2>

<p><img class="right" src="/images/posts/handlers.png" /></p>

<p>Suppose you have a process that listens to a message queue. The messages are just ordinary maps. If the map contains certain keys, one or more handlers must be invoked. Here is a matrix that shows which handler is invoked for which key.</p>

<p>For example, if the map has key <strong><em>a</em></strong>, then DocHandler and AlertHandler need to be called. If it has key <strong><em>b</em></strong>, then NoteHandler and AlertHandler are called. In reality there might be more keys and more handlers, but for simplicity we limit our example to three keys and three handlers.</p>

<!-- more -->

<h2 id="java">Java</h2>

<p>Let’s see how this can be implemented in Java. I chose Java just as an example of non-Lisp language. You can pick any other non-Lisp language instead.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">SimpleMessageListener.java</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleMessageListener</span> <span class="o">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">public</span> <span class="n">List</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">List</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">();</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="o">(</span><span class="n">isDoc</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">&#x7b;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">handleDoc</span><span class="o">(</span><span class="n">message</span><span class="o">));</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="o">(</span><span class="n">isNote</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">&#x7b;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">handleNote</span><span class="o">(</span><span class="n">message</span><span class="o">));</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="o">(</span><span class="n">isAlert</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">&#x7b;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">handleAlert</span><span class="o">(</span><span class="n">message</span><span class="o">));</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c1">// Decision makers</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isDoc</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"a"</span><span class="o">)</span> <span class="o">||</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isNote</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"b"</span><span class="o">)</span> <span class="o">||</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isAlert</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"a"</span><span class="o">)</span> <span class="o">||</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"b"</span><span class="o">);</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c1">// Handlers</span>
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">handleDoc</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Document:%s:%s"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"c"</span><span class="o">));</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">handleNote</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Note:%s:%s"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"b"</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"c"</span><span class="o">));</span>
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">handleAlert</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Alert:%s:%s"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"b"</span><span class="o">));</span>
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">&#x7d;</span></div></div></pre></div></figure>

<p>The internals of <code class="highlighter-rouge">handle</code> methods might be very different in reality. Consider the fact they have the same structure here as a coincidence. What is not coincidence though is the structure of <code class="highlighter-rouge">is</code> methods. Those methods are identical indeed.</p>

<p>Is this code clean? I would say, no. The main issue is that it’s split in three separate but closely related parts. If tomorrow I introduce another message key and a new handler, I have to change three places in the code. Another problem is the code duplication in two spots: a series of <code class="highlighter-rouge">if</code> statements and a group of <code class="highlighter-rouge">is</code> methods.</p>

<p>The last thing to notice about this code is that it’s hard to see what kind of problem it’s trying to solve. If I didn’t provide a matrix which maps message keys to handlers, it would take even more time to figure out what the code is doing.</p>

<p>Can we make this code better? Let’s rewrite it as follows:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">FunctionalMessageListener.java</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FunctionalMessageListener</span> <span class="o">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="kd">interface</span> <span class="nc">Handler</span> <span class="o">&#x7b;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">,</span> <span class="n">List</span> <span class="n">acc</span><span class="o">);</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">DocHandler</span> <span class="kd">implements</span> <span class="n">Handler</span> <span class="o">&#x7b;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isDoc</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"a"</span><span class="o">)</span> <span class="o">||</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">,</span> <span class="n">List</span> <span class="n">acc</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">if</span> <span class="o">(</span><span class="n">isDoc</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="n">acc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Document:%s:%s"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"c"</span><span class="o">)));</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">NoteHandler</span> <span class="kd">implements</span> <span class="n">Handler</span> <span class="o">&#x7b;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isNote</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"b"</span><span class="o">)</span> <span class="o">||</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">,</span> <span class="n">List</span> <span class="n">acc</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">if</span> <span class="o">(</span><span class="n">isNote</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="n">acc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Note:%s:%s"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"b"</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"c"</span><span class="o">)));</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">AlertHandler</span> <span class="kd">implements</span> <span class="n">Handler</span> <span class="o">&#x7b;</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isAlert</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"a"</span><span class="o">)</span> <span class="o">||</span> <span class="n">message</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"b"</span><span class="o">);</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">,</span> <span class="n">List</span> <span class="n">acc</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">if</span> <span class="o">(</span><span class="n">isAlert</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="n">acc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Alert:%s:%s"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"b"</span><span class="o">)));</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Handler</span><span class="o">&gt;</span> <span class="nf">handlers</span><span class="o">()</span> <span class="o">&#x7b;</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="n">DocHandler</span><span class="o">(),</span> <span class="k">new</span> <span class="n">NoteHandler</span><span class="o">(),</span> <span class="k">new</span> <span class="n">AlertHandler</span><span class="o">());</span>
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kd">public</span> <span class="n">List</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Map</span> <span class="n">message</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">List</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">();</span>
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">for</span> <span class="o">(</span><span class="n">Handler</span> <span class="n">handler</span> <span class="o">:</span> <span class="n">handlers</span><span class="o">())</span> <span class="o">&#x7b;</span>
</div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">handler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="o">&#x7d;</span>
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="o">&#x7d;</span>
</div></div><div data-line="45" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">&#x7d;</span></div></div></pre></div></figure>

<p>In this version we eliminated ugly <code class="highlighter-rouge">if</code> series, and grouped together <em>decision making</em> logic and <em>message handling</em>. From that perspective the code became cleaner, but not necessarily clearer. Now it actually takes more effort to understand what the code is doing. Also, the duplication inside the <code class="highlighter-rouge">is</code> methods is still there. We can fix it by extracting it to some abstract class or utility method. We can also use Java reflection within <code class="highlighter-rouge">handlers</code> method to build a collection of handlers without explicitly specifying them. All these manipulations arguably make the code cleaner, but… one thing we’ll never be able to fix is the separation between decision making logic and message handling. <em>Whatever you do, there will always be the if-statement, in one form or another, that checks if you need to process the message, and the message processing logic itself.</em> Those two things will always be separate. This is the point where we hit the language limits.</p>

<h2 id="clojure">Clojure</h2>

<p>Now let’s try to solve the same problem in Lisp and see if we can fix the language to eliminate the last issue from the paragraph above. Here is the direct translation of the previous Java snippet to Clojure dialect of Lisp</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">(defn- doc-handler [msg]
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  (let [a (msg :a), c (msg :c)]
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    (when (or a c)
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">      (format "Document:%s:%s" a c))))
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">(defn- note-handler [msg]
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">  (let [b (msg :b), c (msg :c)]
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    (when (or b c)
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">      (format "Note:%s:%s" b c))))
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">(defn- alert-handler [msg]
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">  (let [a (msg :a), b (msg :b)]
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">    (when (or a b)
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">      (format "Alert:%s:%s" a b))))
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">(defn- handlers []
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">  [doc-handler note-handler alert-handler])
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">(defn on-message [msg]
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">  (letfn [(handle [acc h]
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">            (if-let [res (h msg)]
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">              (conj acc res)
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">              acc))]
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">    (reduce handle [] (handlers))))</div></div></pre></div></figure>

<p>This code is already easier to read, but we can do even better. The separation between decision making logic and message handling is still there. At this point we should ask the question: what kind of code do we want to see there? And the answer is: we want to replace the <code class="highlighter-rouge">-handler</code> methods above with the following code</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">(handler doc [a c]
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  (format "Document:%s:%s" a c))
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">(handler note [b c]
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  (format "Note:%s:%s" b c))
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">(handler alert [a b]
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">  (format "Alert:%s:%s" a b))</div></div></pre></div></figure>

<p>You see: no conditionals. Handlers are self-sufficient entities which know <em>when</em> they have to be applied and <em>how</em>. In their signatures they explicitly declare which message keys they expect, and in the body they just <em>use</em> those keys. No boilerplate: clean and simple. The beauty of Lisp is that you can actually implement that code. The way you do it is by creating a macro which generates the appropriate functions. Creating a macro is not a simple task, I spent quite some time to get this one working, but it’s worth of doing, because it makes the code clean and clear.</p>

<p>We can make one additional step further by moving the <code class="highlighter-rouge">handler</code> declarations inside the <code class="highlighter-rouge">build-handlers</code> function. (We need one small macro for that.) And here is the final solution</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">(defmacro handler [name args &amp; body]
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  `(fn [~'msg]
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">     (let [~@(interleave args (map (fn [x] `(get ~'msg ~(keyword x))) args))]
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">       (when (or ~@args)
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">         ~@body))))
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">(defmacro build-handlers [&amp; body]
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">  `(defn- handlers []
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">     [~@body]))
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">(build-handlers
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">  (handler doc [a c]
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">    (format "Document:%s:%s" a c))
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">  (handler note [b c]
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">    (format "Note:%s:%s" b c))
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">  (handler alert [a b]
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    (format "Alert:%s:%s" a b)))
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">(defn on-message [msg]
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">  (letfn [(handle [acc h]
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">            (if-let [res (h msg)]
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">              (conj acc res)
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">              acc))]
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    (reduce handle [] (handlers))))</div></div></pre></div></figure>

<p>As I said, the first macro might be cryptic, but look at the lines 11–20. This is the essence of our problem, and it cannot be done any simpler. Suppose, we need to implement a new handler which should be called if key <strong><em>c</em></strong> is present in the message. Here what we would need to add to <code class="highlighter-rouge">build-handler</code>’s body to implement this new requirement</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">(handler new [c]
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    ...)</div></div></pre></div></figure>

<p>Simple, right? And what if a new key <strong><em>d</em></strong> is added to the message that should be processed by document handler? Here is what we need to change</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">(handler doc [a c d]
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    ...)</div></div></pre></div></figure>

<p>We just add a new key to the function’s parameter list. That’s it — one-word change.</p>

<h2 id="summary">Summary</h2>

<p>Lisp is the most powerful programming language. By that I mean you can change the language in such a way that the solution to any particular problem can be expressed in the simplest possible way. By changing the language, you can remove all the barriers between the language and the problem domain. I hope I demonstrated this in my simple example.</p>

<h2 id="resources">Resources</h2>

<p>Clojure <a href="https://github.com/ndpar/clojure/blob/master/src/dojo/handler.clj">source</a> code for this blog, along with the <a href="https://github.com/ndpar/clojure/blob/master/test/dojo/handler_test.clj">unit tests</a>.</p>


  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-credit">

      <span class="footer-credit-left">
        Copyright &copy; 2009–2019 Andrey Paramonov
      </span>

      <span class="footer-credit-right">
        Powered by <a href="https://github.com/octopress/octopress">Octopress</a> •
        Hosted by <a href="https://github.com">GitHub</a>
      </span>

    </div>

  </div>

</footer>

  </body>

</html>
